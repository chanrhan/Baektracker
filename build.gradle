/*
 * This file was generated by the Gradle 'init' task.
 *
 * This project uses @Incubating APIs which are subject to change.
 */

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.1'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation libs.org.springframework.boot.spring.boot.starter.security
    implementation libs.org.springframework.boot.spring.boot.starter.web
    testImplementation libs.org.springframework.boot.spring.boot.starter.test
    testImplementation libs.org.springframework.security.spring.security.test
    compileOnly libs.org.springframework.boot.spring.boot.starter.tomcat
    implementation libs.org.springframework.boot.spring.boot.starter.jdbc
    implementation libs.org.mybatis.spring.boot.mybatis.spring.boot.starter
    runtimeOnly libs.org.springframework.boot.spring.boot.devtools

    // JPA
    implementation libs.org.springframework.boot.spring.boot.starter.data.jpa

    // lombok
    implementation libs.org.projectlombok.lombok
    annotationProcessor libs.org.projectlombok.lombok

    implementation libs.net.minidev.json.smart

    // mybatis
    implementation libs.org.mybatis.mybatis
    implementation libs.org.mybatis.mybatis.spring

    // jquery
    implementation libs.org.webjars.jquery

    // log4jdbc
//    implementation libs.org.bgee.log4jdbc.log4j2.log4jdbc.log4j2.jdbc4.v1

    // p6spy (sql log)
//    implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.9.0'

    // Quartz
    implementation libs.org.springframework.boot.spring.boot.starter.quartz

    implementation libs.org.jsoup.jsoup

    // flyway
    implementation libs.org.flywaydb.flyway.mysql

    // mysql
    runtimeOnly libs.com.mysql.mysql.connector.j

    // QueryDSL
    implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'
    annotationProcessor "com.querydsl:querydsl-apt:5.0.0:jakarta"
    annotationProcessor "jakarta.annotation:jakarta.annotation-api:2.1.1"
    annotationProcessor "jakarta.persistence:jakarta.persistence-api:3.1.0"
}

group = 'com.baektracker'
version = '0.0.1-SNAPSHOT'
description = 'baektracker'
java.sourceCompatibility = JavaVersion.VERSION_17

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    options.compilerArgs += ['-parameters']
}

tasks.withType(Javadoc) {
    options.encoding = 'UTF-8'
}

def frontendDir = "$projectDir/src/main/frontend"
def querydslDir = layout.buildDirectory.dir("generated/querydsl").get().asFile
def reactBuildDir = layout.buildDirectory.dir("frontend").get().asFile

sourceSets {
    main {
        java {
            srcDir querydslDir
        }
        resources {
            srcDirs = ["$projectDir/src/main/resources"]
        }
    }
}

// ✅ (추가) Q 클래스 생성 위치를 querydslDir로 고정
tasks.withType(JavaCompile).configureEach {
    options.generatedSourceOutputDirectory = querydslDir
}

tasks.named("jar") {
    dependsOn("copyReactBuildFiles")
    from(reactBuildDir) {
        into("static")   // classpath:/static/ 로 들어감
    }
}

tasks.named("bootJar") {
    dependsOn("copyReactBuildFiles")
    from(reactBuildDir) {
        into("static")
    }
}

tasks.register('installReact', Exec) {
    workingDir "$frontendDir"
    inputs.dir "$frontendDir"
    group = BasePlugin.BUILD_GROUP
    if (System.getProperty('os.name').toLowerCase(Locale.ROOT).contains('windows')) {
        commandLine 'npm.cmd', 'ci'
    } else {
        commandLine 'npm', 'ci'
    }
}

tasks.register('buildReact', Exec) {
    dependsOn "installReact"
    workingDir "$frontendDir"
    inputs.dir "$frontendDir"
    group = BasePlugin.BUILD_GROUP
    if (System.getProperty('os.name').toLowerCase(Locale.ROOT).contains('windows')) {
        commandLine "npm.cmd", "run-script", "build"
    } else {
        commandLine "npm", "run-script", "build"
    }
}
tasks.register('copyReactBuildFiles', Copy) {
    dependsOn "buildReact"
    from "$frontendDir/build"
    into reactBuildDir
}